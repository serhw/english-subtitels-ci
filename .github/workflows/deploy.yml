name: Deploy to Docker Swarm

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Deploy to Docker Swarm
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        script: |
          # Create deployment directory if it doesn't exist
          mkdir -p /opt/english-subtitels
          cd /opt/english-subtitels
          
          # Download docker-compose file
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o docker-compose.yml \
               https://api.github.com/repos/${{ github.repository }}/contents/docker-compose.production.yml
          
          # Create required secrets if they don't exist (you may need to set these manually)
          echo "Checking for required Docker secrets..."
          docker secret inspect subtitles_seq_api_key >/dev/null 2>&1 || echo "Warning: subtitles_seq_api_key secret not found"
          docker secret inspect subtitles_db_connection >/dev/null 2>&1 || echo "Warning: subtitles_db_connection secret not found"
          
          # Deploy the stack
          docker stack deploy -c docker-compose.yml --with-registry-auth english-subtitels
          
          # Wait for deployment
          sleep 30
          
          # Show service status
          docker stack services english-subtitels
          
          # Clean up old images
          docker system prune -f
